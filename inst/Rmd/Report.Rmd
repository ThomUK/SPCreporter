---
output: 
  html_document:
    css: ["css/details_summary.css", "css/style.css"]
    theme: cosmo
    mathjax: null
    toc: true
    toc_float:
      collapsed: false
title: "`r document_title`"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, results = 'asis')



# default NHS logo
if (logo_path == "nhs") {
  # logo_path <- system.file("img/NHS_logo.jpg", package = "SPCreporter")
  logo_path <- "../img/NHS_logo.jpg"
}

```

<style type="text/css">
  body { background-color: `r paper_colour`; }
  #logo_block .department { color: `r department_text_colour`; }
</style>

:::: {#header_bar}

::: {#title_data}

# `r title`


## `r subtitle`


#### Report reference: `r report_ref`


#### Report creation date-time: `r format.Date(Sys.time(), "%d/%m/%Y, %H:%M %p")`


#### Data cutoff date-time: `r format.Date(data_cutoff_dttm, "%d/%m/%Y, %H:%M %p")`

:::

::: {#logo_block}

![Logo](`r logo_path`)

##### `r department` {.department}

:::

::::



## Notes:

`r intro`

A key explaining how to read the icons for Variation, Assurance, and Data Quality is at the [bottom of this document](#icon-key).

```{r main-content, fig.height=4, fig.width=7, message=FALSE}

# add the header bar
spcr_add_header_bar(
  include_dq_icon = include_dq_icon
)

# build the report accordions row by row
purrr::pwalk(
  data_bundle, 
  spcr_render_accordion, 
  accordion_colour = accordion_colour,
  include_dq_icon = include_dq_icon
)

```

---


```{r fun, include=FALSE}
v_icon_path <- function(x) glue::glue("../img/variation_icons/{x}.png")
v_labs <- c(paste(paste("SC", rep(c("HI", "LO"), 3), sep = "_"),
                  c("CON", "IMP", "NEUTRAL"), sep = "_"), "CC")
v_paths <- purrr::map(v_labs, v_icon_path) |>
  purrr::set_names(v_labs)
a_icon_path <- function(x) glue::glue("../img/assurance_icons/{x}_TARG.png")
a_labs <- c("PASS", "RND", "FAIL")
a_paths <- purrr::map(a_labs, a_icon_path) |>
  purrr::set_names(a_labs)
```

<!-- HTML to render the dropdown containing the icon key -->

::: {#icon-key}

<details>
  <summary>
    <h4 class="outer_flex" style="justify-content: flex-start;">
    How to read the icons used in this document
    </h4>
  </summary>

::: {.details_content}

#### SPC Variation Icons

Used to summarise the type of variation seen in the most recent data point of a given measure.

| Icons | Variation Type |
|:-----:|:---------------|
![SC_HI_CON icon](`r v_paths$SC_HI_CON`) ![SC_LO_CON icon](`r v_paths$SC_LO_CON`) | The most recent data point exhibits special cause variation (in a concerning direction).  H is high, L is Low.
![SC_HI_IMP icon](`r v_paths$SC_HI_IMP`) ![SC_LO_IMP icon](`r v_paths$SC_LO_IMP`) | The most recent data point exhibits special cause variation (in an improving direction).  H is high, L is Low.
![SC_HI_NEUTRAL icon](`r v_paths$SC_HI_NEUTRAL`) ![SC_LO_NEUTRAL icon](`r v_paths$SC_LO_NEUTRAL`) | The most recent data point exhibits special cause variation, but neither direction represents concern or improvement (ie. the measure is neutral).  H is high, L is low.
![CC icon](`r v_paths$CC`) | The most recent data point exhibits common cause variation (ie. naturally-occurring variation, that is not statistically significant).

#### SPC Assurance Icons

Used to summarise whether a measure is assured to meet a target.

| Icons | Assurance Type |
|:-----:|:---------------|
![PASS_TARG icon](`r a_paths$PASS`) | The process is assured, and is likely to consistently pass the target set.
![RND_TARG icon](`r a_paths$RND`) | The process is not assured, and will pass and fail the target based on variation in the process.
![FAIL_TARG icon](`r a_paths$FAIL`) | The process is not assured, and is likely to consistently fail to meet the target set.

:::

</details>

:::

---

<!-- Footer -->

::: {#footer}

Report reference:  `r report_ref`

Report author:  `r author_name` [`r author_email`](`r paste0("mailto:", author_email, "?subject=Report ", report_ref, "...")`)

END
:::


<details>
<summary>Session info</summary>
`r utils::sessionInfo()`
</details>
